<view style="display:flex;flex-direction:column;height:100vh;">
  <view id="topbar" style="display:flex;flex-direction:column;gap:12rpx;padding:12rpx;border-bottom:1px solid #eee;">
    <view style="display:flex;align-items:center;gap:12rpx;">
      <picker mode="selector" range="{{maps}}" range-key="mapName" value="{{selectedMapIndex}}" bindchange="bindMapChange" disabled="{{!gotmaps || showLine}}">
        <view style="padding:8rpx 16rpx;border:1px solid {{(!gotmaps || showLine) ? '#bbb' : '#ddd'}};border-radius:8rpx;background-color:{{(!gotmaps || showLine) ? '#f5f5f5' : '#fff'}};color:{{(!gotmaps || showLine) ? '#999' : '#333'}};">当前地图：{{(maps[selectedMapIndex] && maps[selectedMapIndex].mapName) || ''}}</view>
      </picker>
      <picker mode="selector" range="{{roomPoints}}" range-key="pointName" value="{{selectedStartIndex}}" bindchange="bindStartChange" disabled="{{!gotmaps || showLine}}">
      <view style="padding:8rpx 16rpx;border:1px solid {{(!gotmaps || showLine) ? '#bbb' : '#ddd'}};border-radius:8rpx;background-color:{{(!gotmaps || showLine) ? '#f5f5f5' : '#fff'}};color:{{(!gotmaps || showLine) ? '#999' : '#333'}};">起点：{{selectedStartIndex < 0 ? '走廊' : ((roomPoints[selectedStartIndex] && roomPoints[selectedStartIndex].pointName) || '')}}</view>
      </picker>
      <picker mode="selector" range="{{roomPoints}}" range-key="pointName" value="{{selectedEndIndex}}" bindchange="bindEndChange" disabled="{{!gotmaps || showLine}}">
      <view style="padding:8rpx 16rpx;border:1px solid {{(!gotmaps || showLine) ? '#bbb' : '#ddd'}};border-radius:8rpx;background-color:{{(!gotmaps || showLine) ? '#f5f5f5' : '#fff'}};color:{{(!gotmaps || showLine) ? '#999' : '#333'}};">终点：{{selectedEndIndex < 0 ? '走廊' : ((roomPoints[selectedEndIndex] && roomPoints[selectedEndIndex].pointName) || '')}}</view>
      </picker>
    </view>
    <view style="display:flex;align-items:center;gap:12rpx;">
      <button size="mini" wx:if="{{showLine}}" disabled="{{!gotmaps || selectedPathIndex <= 0}}" bindtap="onPrevPath">上一页</button>
      <button size="mini" disabled="{{!gotmaps}}" bindtap="onQuery">{{showLine ? '结束查询' : '开始查询'}}</button>
      <button size="mini" wx:if="{{showLine}}" disabled="{{!gotmaps || selectedPathIndex >= (paths.length - 1)}}" bindtap="onNextPath">下一页</button>
    </view>
  </view>
  <view style="flex:1;display:flex;justify-content:center;align-items:center;">
    <block wx:if="{{!gotmaps}}">
      
      <view style="display:flex;flex-direction:column;align-items:center;gap:16rpx;color:#666;">
        <image mode="aspectFit" src="../../image/not.png"></image>
        <text>无法查看地图</text>
      </view>
    </block>
    <block wx:else>
      <canvas wx:if="{{!showOrderPicker}}" canvas-id="navCanvas" style="width:{{canvasWidth}}px;height:{{canvasHeight}}px;" width="{{canvasWidth}}" height="{{canvasHeight}}" bindtap="onCanvasTap"></canvas>
    </block>
  </view>
  <view style="padding:12rpx;border-top:3px solid #eee;display:flex;flex-direction:column;gap:12rpx;">
    <view style="display:flex;justify-content:center;gap:16rpx;">
      <button size="mini" disabled="{{!gotmaps || showLine}}" bindtap="onScanLocation">扫码获取当前位置</button>
      <button size="mini" disabled="{{!gotmaps || showLine}}" bindtap="onBluetoothLocation">蓝牙获取当前位置</button>
    </view>
    <view style="display:flex;justify-content:center;gap:16rpx;">
      <button size="mini" disabled="{{!gotmaps || showLine}}" bindtap="openOrderPicker">从预约记录获取终点</button>
    </view>
  </view>
  <view wx:if="{{showOrderPicker}}" style="position:fixed;left:0;top:0;right:0;bottom:0;background:rgba(0,0,0,0.4);display:flex;align-items:center;justify-content:center;z-index:9999;">
    <view style="width:84%;max-height:80vh;background:#fff;border-radius:16rpx;overflow:hidden;display:flex;flex-direction:column;">
      <view style="padding:20rpx 24rpx;border-bottom:1px solid #eee;font-weight:600;display:flex;align-items:center;justify-content:space-between;">
        <text>选择预约记录</text>
      </view>
      <scroll-view scroll-y="true" style="padding:16rpx 24rpx;max-height:60vh;height:60vh;">
        <block wx:if="{{orderList && orderList.length}}">
          <block wx:for="{{orderList}}" wx:key="appointmentId">
            <view data-index="{{index}}" bindtap="onChooseOrder" style="padding:16rpx 0;border-bottom:1px solid #f0f0f0;">
              <view>预约号：{{item.appointmentNo}}</view>
              <view>医生：{{item.doctorName}}</view>
              <view>科室：{{item.departmentName}}</view>
            </view>
          </block>
        </block>
        <block wx:else>
          <view style="padding:40rpx 0;text-align:center;color:#999;">暂无预约记录</view>
        </block>
      </scroll-view>
      <view style="padding:12rpx 24rpx;border-top:1px solid #eee;display:flex;justify-content:flex-end;">
        <button size="mini" type="default" bindtap="closeOrderPicker">关闭</button>
      </view>
    </view>
  </view>
</view>
